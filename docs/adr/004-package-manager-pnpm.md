# ADR-004: パッケージマネージャー: pnpm

## ステータス

Accepted

## コンテキスト

Node.js プロジェクトのパッケージマネージャーを選定する必要がある。
インストール速度、ディスク使用量、信頼性を考慮して選定する。

## 決定

pnpm を採用する。

## 選択肢

### 選択肢 1: pnpm

- メリット
  - 高速なインストール（npm の 2〜3 倍）
  - ディスク使用量が少ない（コンテンツアドレッサブルストレージ）
  - 厳格な依存関係管理（ファントム依存を防止）
  - モノレポサポートが優れている
  - Corepack でバージョン管理が容易
- デメリット
  - npm と比較して普及率が低い
  - 一部のパッケージで互換性問題が発生する可能性

### 選択肢 2: npm

- メリット
  - Node.js に標準で付属
  - 最も広く使われており、情報が豊富
  - 互換性問題が少ない
- デメリット
  - インストール速度が遅い
  - ディスク使用量が多い
  - ファントム依存が発生しやすい

### 選択肢 3: yarn (Classic / Berry)

- メリット
  - npm より高速
  - Plug'n'Play (PnP) でゼロインストール可能
  - ワークスペース機能が充実
- デメリット
  - PnP は互換性問題が多い
  - Classic と Berry で設定が大きく異なる
  - 設定が複雑

### 選択肢 4: bun

- メリット
  - 非常に高速
  - ランタイム、テストランナーも統合
- デメリット
  - まだ安定版ではない
  - Node.js との互換性問題がある
  - エコシステムが未成熟

## 理由

pnpm を採用する理由は以下の通り：

1. **速度**: npm と比較して 2〜3 倍高速なインストール
2. **ディスク効率**: コンテンツアドレッサブルストレージにより、同じパッケージを複数プロジェクトで共有
3. **厳格な依存関係**: node_modules のフラット化を避け、ファントム依存を防止
4. **Corepack 対応**: package.json の packageManager フィールドでバージョンを固定可能
5. **実績**: 多くのメジャープロジェクト（Vue、Vite など）で採用されている

## 結果

- pnpm を package.json の packageManager フィールドで指定
- Corepack を使用してバージョンを統一
- CI/CD でも pnpm を使用
- .npmrc で save-exact=true を設定し、依存関係のバージョンを固定
